---
import BaseHead from "../components/BaseHead.astro";
import { JesterButton } from "@ecumene/ui";
import ProjectCard from "../components/ProjectCard";
import Shape from "../vectorDisplays/Shape";
import MyHead from "../vectorDisplays/MyHead";
import MySignature from "../vectorDisplays/MySignature";
import CardFan from "../components/CardFan";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { getCollection } from "astro:content";

const projects = (await getCollection("projects")).sort(
  (a, b) => a.data.pubDate.valueOf() - b.data.pubDate.valueOf()
);
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <style>
      .cta-animated {
        position: relative;
        display: inline-block;
        border-radius: 0.5rem;
        overflow: visible;
      }
      .cta-animated::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        transform-origin: center;
        box-shadow: 0 0 0 0 rgba(185, 28, 28, 0);
        opacity: 1;
        /* stronger continuous pulse */
        animation: cta-pulse 2000ms infinite cubic-bezier(0.2, 0.9, 0.2, 1);
      }
      @media (prefers-reduced-motion: reduce) {
        .cta-animated::after {
          animation: none;
          transition: none;
          transform: none;
          box-shadow: none;
        }
      }
      @keyframes cta-pulse {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(185, 28, 28, 0.25);
          opacity: 0.8;
        }
        100% {
          transform: scale(1.3);
          box-shadow: 0 0 0 20px rgba(185, 28, 28, 0);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <main class="relative">
      <div class="absolute w-screen max-w-full aspect-video overflow-hidden">
        <div class="absolute top-[-50px] md:top-[-200px] left-0 bg-sky-100">
          <Shape className="text-rose-800 w-screen h-auto max-w-full" />
        </div>
        <div class="absolute right-[20px] top-[0px]">
          <div class="relative w-[47vw]">
            <MyHead
              width="680"
              height="907"
              className="absolute top-[0px] w-full h-auto"
            />
            <img
              src="/head.png"
              alt="My face"
              width={680}
              height={907}
              class="absolute top-[0px] w-full h-auto"
            />
          </div>
        </div>
        <Shape
          className="text-background absolute top-0 left-0 w-screen h-auto max-w-full"
        />
      </div>
      <nav class="sticky top-0 z-50">
        <div
          id="nav-container"
          class="absolute max-w-xl mx-auto px-4 pt-4 relative"
        >
          <ul class="flex items-center justify-center gap-6 py-2 text-xl">
            <li>
              <a
                href="#home"
                aria-current="false"
                class="hover:text-rose-800 transition-colors">Home</a
              >
            </li>
            <li>
              <a
                href="#about"
                aria-current="false"
                class="hover:text-rose-800 transition-colors">About</a
              >
            </li>
            <li>
              <a
                href="#projects"
                aria-current="false"
                class="hover:text-rose-800 transition-colors">Projects</a
              >
            </li>
            <li>
              <a
                href="https://jestersprivilege.ca"
                aria-current="false"
                class="hover:text-rose-800 transition-colors">Blog</a
              >
            </li>
          </ul>
          <span
            id="nav-underline"
            class="pointer-events-none absolute bottom-0 left-0 block h-[2px] w-0 bg-rose-800 rounded transition-all duration-300 ease-out"
          ></span>
        </div>
      </nav>
      <div
        class="absolute flex flex-col items-center justify-between p-4 md:p-24 w-screen max-w-full aspect-video gap-10 lg:gap-32"
      >
        <div
          id="home"
          class="text-center gap-2 flex flex-col mt-40 md:m-0 w-full flex-1 justify-end"
        >
          <div class="md:w-1/2 p-8 border-dashed relative py-40">
            <img
              src="/background.png"
              alt="White paint background"
              width={337}
              height={234}
              class="w-full absolute top-[50%] -translate-y-1/2 left-0"
            />
            <CardFan client:only="react" className="z-10 mt-[-12rem] mb-10" />
            <MySignature
              width="1571"
              height="432"
              className="relative z-10 w-1/2 h-auto mx-auto"
            />
            <p class="text-lg mt-4 md:text-2xl relative z-10 font-bold">
              Full-Stack Software Developer
            </p>
            <div
              class="mb-8 mt-2 z-10 relative text-md md:text-xl font-medium text-center"
            >
              <a href="https://spellbook.com">
                Computing law at <span class="underline">spellbook.com</span>
              </a>
              <div class="mt-6">
                <a
                  href="#projects"
                  class="inline-block bg-rose-800 text-white font-semibold px-5 py-2 rounded shadow hover:bg-rose-700 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:ring-offset-2 transition-colors cta-animated"
                >
                  View Projects
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/** Hugh Mungus Spacer */}
      <div class="aspect-video w-screen max-w-full"></div>

      <section
        id="about"
        class="w-screen max-w-full flex flex-col-reverse md:flex-row px-4 md:mx-0 items-center md:items-start justify-center gap-8 md:mt-0 mt-96 pb-32 scroll-mt-24"
      >
        <div class="flex flex-col text-center">
          <JesterButton client:only="react" />
        </div>
        <div class="flex flex-col">
          <h1 class="text-4xl font-bold mb-4">Who am I</h1>
          <p class="max-w-sm">
            I'm a Full-Stack Software Developer at&nbsp;<a
              class="text-rose-800 font-bold px-0"
              href="https://spellbook.com">Spellbook</a
            >. I like learning new things and solving problems. I'm passionate
            about ancient books, rock music, cuban cigars and healthy tasty
            food. I live in St. John's, Canada with my Fianc√©e and our two cats.
          </p>
          <p class="max-w-sm mt-4">
            I have a blog called&nbsp;<a
              class="text-rose-800 font-bold px-0"
              href="https://jestersprivilege.ca">Jester's Privilege</a
            >
          </p>
        </div>
        <div class="flex flex-col text-center mt-6">
          <img
            src="/profile.jpeg"
            alt="About"
            width="169"
            height="245"
            class="w-[169px] h-[245px] object-cover rounded-lg border-2 border-black bg-white hover:scale-105 transition-transform duration-300 ease-in-out"
          />
        </div>
      </section>

      <section id="projects" class="scroll-mt-24">
        <div class="max-w-4xl mx-auto px-4">
          <h1 class="text-4xl font-bold mb-4">Projects</h1>
        </div>

        <div class="max-w-4xl mx-auto px-4 mt-8 mb-32 flex flex-col gap-4">
          {
            projects.map((project) => (
              <ProjectCard
                slug={project.slug}
                project={project.data}
                client:load
              />
            ))
          }
        </div>
      </section>
    </main>
    <script>
      // Highlight active nav link by section visibility
      /** @type {Array<'home'|'about'|'projects'>} */
      const sectionIds = ["home", "about", "projects"];
      /** @type {HTMLElement[]} */
      const sections = sectionIds
        .map((id) => document.getElementById(id))
        .filter((el) => el instanceof HTMLElement);
      /** @type {HTMLAnchorElement[]} */
      const links = Array.from(
        document.querySelectorAll('nav a[href^="#"]')
      ).filter((el) => el instanceof HTMLAnchorElement);

      let currentSectionId = "";
      function updateActive() {
        links.forEach((link) => {
          const href = link.getAttribute("href");
          const isActive = href === `#${currentSectionId}`;
          link.setAttribute("aria-current", isActive ? "page" : "false");
        });

        // Move animated underline
        const container = document.getElementById("nav-container");
        const underline = document.getElementById("nav-underline");
        if (!container || !underline) return;
        const activeLink = links.find(
          (l) => l.getAttribute("href") === `#${currentSectionId}`
        );
        if (!activeLink) {
          underline.style.width = "0px";
          return;
        }
        const containerRect = container.getBoundingClientRect();
        const linkRect = activeLink.getBoundingClientRect();
        const left = linkRect.left - containerRect.left;
        underline.style.transform = `translateX(${left}px)`;
        underline.style.width = `${linkRect.width}px`;
      }

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              currentSectionId = entry.target.id;
              updateActive();
            }
          });
        },
        {
          root: null,
          rootMargin: "0px 0px -60% 0px",
          threshold: 0.1,
        }
      );

      sections.forEach((section) => observer.observe(section));

      if (location.hash) {
        currentSectionId = location.hash.slice(1);
        updateActive();
      } else {
        // default to first section
        currentSectionId = sectionIds[0] ?? "";
        updateActive();
      }

      links.forEach((link) => {
        link.addEventListener("click", () => {
          const href = link.getAttribute("href");
          if (!href) return;
          currentSectionId = href.replace("#", "");
          updateActive();
        });
      });

      // Reposition underline on resize
      window.addEventListener("resize", () => updateActive());
    </script>
  </body>
</html>
